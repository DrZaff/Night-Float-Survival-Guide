// UC Night Float Survival Guide (updated from Content-File.pdf)
// Offline-capable sections with in-app reference viewer.

/* ===========================
   DATA (SECTIONS)
   =========================== */

const APP_TITLE = "UC Night Float Survival Guide";

const SECTIONS = [{"title":"Antiemetics","html":"<ul class=\"clinical-list level-1\">\n<li>Common agents: Check last EKG for QTc\n  <ul class=\"clinical-list level-2\">\n    <li>Zofran 4mg IV/PO q6hrs prn</li>\n    <li>Phenergan 12.5-25mg PO/IV/IM q6 hrs prn</li>\n    <li>Compazine 5-10mg PO/IV/IM q6-8 hrs prn</li>\n  </ul>\n</li>\n<li>Others:\n  <ul class=\"clinical-list level-2\">\n    <li>Diphenhydramine 25-50 mg PO q 6 or 10 mg IV q 6</li>\n    <li>Scopolamine 1.5 mg patch q 72 hr - uses: preventative</li>\n    <li>Lorazepam - uses: refractory nausea</li>\n    <li>Dexamethasone - uses: prophylactic, chemotherapy-related</li>\n  </ul>\n</li>\n</ul>","sources":[]},{"title":"Abdominal pain","html":"<ul class=\"clinical-list level-1\">\n<li>Assessing Abdominal Pain\n  <ul class=\"clinical-list level-2\">\n    <li>Is this new or old, is it worsening?</li>\n    <li>If new or worsening, <strong>go see and evaluate patient</strong></li>\n    <li>What are the vitals?</li>\n    <li>Why is the patient admitted?</li>\n  </ul>\n</li>\n<li>Differential Guide by Location\n  <ul class=\"clinical-list level-2\">\n    <li><strong>Diffuse:</strong> Peritonitis\n      <ul class=\"clinical-list level-3\">\n        <li><em>Mimics:</em> Diabetic Ketoacidosis, Adrenal Insufficiency</li>\n      </ul>\n    </li>\n    <li><strong>Epigastric:</strong> PUD, pancreatitis, gastritis, AAA\n      <ul class=\"clinical-list level-3\">\n        <li><em>Mimics:</em> Myocardial Infarction</li>\n      </ul>\n    </li>\n    <li><strong>RUQ:</strong> cholecystitis, biliary colic, cholangitis, hepatitis\n      <ul class=\"clinical-list level-3\">\n        <li><em>Mimics:</em> PE, pulmonary infarction, pneumonia, rib fracture</li>\n      </ul>\n    </li>\n    <li><strong>LUQ:</strong> Gastritis, pancreatitis, ovarian torsion, ectopic pregnancy\n      <ul class=\"clinical-list level-3\">\n        <li><em>Mimics:</em> splenic infarction, rib fracture</li>\n      </ul>\n    </li>\n    <li><strong>RLQ:</strong> Appendicitis, ureteral kidney stone, hernia, ovarian torsion, ectopic pregnancy, constipation</li>\n    <li><strong>LLQ:</strong> Diverticulitis, ureteral kidney stone, hernia</li>\n    <li><strong>Suprapubic:</strong> Cystitis, bladder outlet obstruction</li>\n  </ul>\n</li>\n<li>Urgent diagnoses requiring surgical consultation and co-management:\n  <ul class=\"clinical-list level-2\">\n    <li><strong>Peritonitis:</strong> severe pain with +rebound, +guarding, absent bowel sounds. Upright abdominal imaging with +free air.</li>\n    <li><strong>Ischemic bowel:</strong> pain out of proportion to exam, +bloody stool.</li>\n    <li><strong>Abdominal Aortic Aneurysm:</strong> severe pain, large pulsatile mass, hypotension</li>\n    <li><strong>Obstruction:</strong> nausea, vomiting, bloat/distention. AXR with air-fluid levels and transition point</li>\n    <li><strong>Cholangititis:</strong> Fever, RUQ pain, jaundice (+/- hypotension and AMS). LFTs in cholestatic pattern.</li>\n  </ul>\n</li>\n<li>Work up\n  <ul class=\"clinical-list level-2\">\n    <li>Consider CBC, Lactate, Lipase, LFTs, UA, Abdominal XR, CT versus ultrasound (cannot be done overnight)</li>\n  </ul>\n</li>\n<li><strong>Note:</strong> If surgical evaluation warranted, consider holding narcotic administration until surgical team has performed bedside exam.</li>\n</ul>","sources":[]},{"title":"Adults with Medical Complexity","html":"<ul class=\"clinical-list level-1\">\n<li>Adults with medical complexity typically have complex, chronic medical conditions associated with use of medical technology and increased need for care coordination.</li>\n<li>We are seeing more adults with medical complexity as they outgrow their pediatric team, please use these one-pagers as a reference! (Med-peds attendings are a great resource in a pinch!)\n  <ul class=\"clinical-list level-2\">\n    <li>Airway Clearance one-pager (<a href=\"Airway-Clearance.pdf\" class=\"ref-link\" data-ref=\"Airway-Clearance.pdf\">Linked</a>)</li>\n    <li>Tracheostomy one-pager (<a href=\"Tracheostomies.pdf\" class=\"ref-link\" data-ref=\"Tracheostomies.pdf\">Linked</a>)</li>\n    <li>Shunts one-pager (<a href=\"shunts.pdf\" class=\"ref-link\" data-ref=\"shunts.pdf\">Linked</a>)</li>\n    <li>Baclofen pump one-pager (<a href=\"Baclofen.pdf\" class=\"ref-link\" data-ref=\"Baclofen.pdf\">Linked</a>)</li>\n    <li>G-Tube one-pager (<a href=\"Enteral-Feeding.pdf\" class=\"ref-link\" data-ref=\"Enteral-Feeding.pdf\">Linked</a>)</li>\n    <li>Autonomic Dysfunction one-pager (<a href=\"Autonomic-Dysfunction.pdf\" class=\"ref-link\" data-ref=\"Autonomic-Dysfunction.pdf\">Linked</a>)</li>\n  </ul>\n</li>\n</ul>","sources":[]},{"title":"Altered Mental Status","html":"<ul class=\"clinical-list level-1\">\n<li>Calls regarding a change in mental status always warrant prompt notification of your senior and bedside evaluation of the patient.</li>\n<li><strong>Step 1.</strong> Determine urgency of call – Gather some specifics from nurse. Essential questions include: What has changed? What is the patient’s general appearance/status currently? Last time seen normal? New set of vitals?\n  <ul class=\"clinical-list level-2\">\n    <li><strong>If patient acutely non-responsive, reasonable to ask nurse to call a rapid/code (582-3333).</strong> If patient is flipping through TV channels and only seemed slightly forgetful, have time to gather more information. If there is ANY concern for possible stroke, call a rapid response 1st, then initiate Stroke Team (584-8282).</li>\n  </ul>\n</li>\n<li><strong>Step 2.</strong> Information gathering – Review signout, H&amp;P and most recent progress note can be helpful, meds (anti-cholingergics? Opioids? Benzos?), labs. Finally, obtain new vitals if not already done and perform bedside exam with focus on mental status and neuro exam.</li>\n<li><strong>Step 3.</strong> Differential and diagnostic testing – Focus diagnostic testing on most common and life threatening causes of delirium. Below is a limited list to get you started.\n  <ul class=\"clinical-list level-2\">\n    <li><strong>Drugs</strong> – Evidence of illicit drug use? opioids, benzos, anti-cholinergics? Any new meds?</li>\n    <li><strong>Electrolyte/metabolic disturbances</strong></li>\n    <li><strong>Lack of drugs</strong> – alcohol/benzo withdrawl?</li>\n    <li><strong>Infection</strong> – UTI? Pneumonia? Cellulitis? Bacteremia?</li>\n    <li><strong>Reduced sensory inputs</strong> – Glasses? Hearing aids?</li>\n    <li><strong>Intracranial disorders</strong> – new focal deficits?</li>\n    <li><strong>Urinary and fecal disorders</strong> – Urinary retention? Constipation?</li>\n    <li><strong>Myocardial/pulmonary disorders</strong> – MI, COPD, HF, etc?</li>\n  </ul>\n</li>\n</ul>","sources":[]},{"title":"Agitation","html":"<ul class=\"clinical-list level-1\">\n<li>What should I do if my patient is agitated with aggression?\n  <ul class=\"clinical-list level-2\">\n    <li>Can call if a <strong>code violet</strong> if patient is an imminent threat to self or others</li>\n    <li>Otherwise, try de-escalation techniques:\n      <ul class=\"clinical-list level-3\">\n        <li>Reorient</li>\n        <li>Do not argue with patient, be respectful</li>\n        <li>Involve family if possible, even over phone</li>\n        <li>Initiate &quot;Sleep Care Bundle&quot; orderset to prevent and treat delirium</li>\n      </ul>\n    </li>\n    <li>Is the patient easily reoriented and redirectable? Would a <strong>Telesitter</strong> or <strong>Sitter work</strong>?</li>\n    <li>Physical restraints and pharmacologic sedation – Only appropriate if patient is exhibiting behavior that is dangerous to the patient or others. Examples of dangerous behavior can include pulling at lines, tubes, and drains.</li>\n  </ul>\n</li>\n\n<li>Pharmacologic options:\n  <ul class=\"clinical-list level-2\">\n    <li>\n      <div class=\"drop\">\n        <button class=\"drop-btn\" type=\"button\" aria-expanded=\"false\">\n          <span>Antipsychotics are the preferred agent. Start with low dose. Before administration, review ECG or obtain ECG to check QTc. QTc prolongation is a relative contraindication for administration of anti-psychotics. Below is some general information regarding the most commonly used anti-psychotics:</span>\n          <span class=\"chev\">▾</span>\n        </button>\n        <div class=\"drop-panel\" hidden>\n          <ul class=\"clinical-list level-3\">\n            <li>Haloperidol\n              <ul class=\"clinical-list level-3\">\n                <li>Initial dose: 0.25 - 0.5 mg</li>\n                <li>Routes: Oral, IM, or IV (IV associated with greater QTc prolongation, avoid)</li>\n                <li>Degree of sedation: Low</li>\n                <li>Risk of extrapyramidal symptoms: High</li>\n              </ul>\n            </li>\n            <li>Risperidone\n              <ul class=\"clinical-list level-3\">\n                <li>Initial dose: 0.25 - 0.5 mg</li>\n                <li>Routes: Oral, IM</li>\n                <li>Degree of sedation: Low</li>\n                <li>Risk of extrapyramidal symptoms: High</li>\n              </ul>\n            </li>\n            <li>Olanzapine\n              <ul class=\"clinical-list level-3\">\n                <li>Initial dose: 2.5 - 5 mg</li>\n                <li>Routes: Oral, sublingual, IM</li>\n                <li>Degree of sedation: Moderate</li>\n                <li>Risk of extrapyramidal symptoms: Moderate</li>\n              </ul>\n            </li>\n            <li>Quetiapine\n              <ul class=\"clinical-list level-3\">\n                <li>Initial dose: 12.5 - 25 mg</li>\n                <li>Routes: Oral</li>\n                <li>Degree of sedation: High</li>\n                <li>Risk of extrapyramidal symptoms: Low</li>\n              </ul>\n            </li>\n          </ul>\n        </div>\n      </div>\n    </li>\n  </ul>\n</li>\n\n<li>Notes:\n  <ul class=\"clinical-list level-2\">\n    <li>Benzodiazepines should be avoided as the amnestic effect of benzos will tend to worsen delirium, but may have to be used in some circumstances.</li>\n    <li><strong>Patient should be seen and plan reviewed with senior prior to administration of any new meds.</strong></li>\n  </ul>\n</li>\n</ul>","sources":["Marcantonio, Edward R. \"Delirium in hospitalized older adults.\" New England Journal of Medicine 377.15 (2017): 1456-1466"]}];

// ===== VALIDATION NOTE (Chunk A) =====
// This build includes the first 5 sections only: Antiemetics, Abdominal pain, Adults with Medical Complexity, Altered Mental Status, Agitation.
// Once you confirm rendering + bullet alignment + dropdown behavior, we will append Chunk B (next sections) without changing app architecture.

/* ===========================
   DOM + STATE
   =========================== */

const els = {
  homeView: document.getElementById("homeView"),
  sectionView: document.getElementById("sectionView"),
  refView: document.getElementById("refView"),
  sectionTitle: document.getElementById("sectionTitle"),
  sectionMeta: document.getElementById("sectionMeta"),
  sectionContent: document.getElementById("sectionContent"),
  backBtn: document.getElementById("backBtn"),
  refBackBtn: document.getElementById("refBackBtn"),
  refFrame: document.getElementById("refFrame"),
  refMeta: document.getElementById("refMeta"),
  searchInput: document.getElementById("searchInput"),
  homeIconBtn: document.getElementById("homeIconBtn"),
};

const state = {
  currentIndex: null,
  lastView: "home", // "home" | "section" | "ref"
};

/* ===========================
   HELPERS
   =========================== */

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("\"", "&quot;")
    .replaceAll("'", "&#039;");
}

function setTitle(text) {
  document.title = text ? `${text} — ${APP_TITLE}` : APP_TITLE;
}

function showEl(el) {
  el.classList.remove("hidden");
}

function hideEl(el) {
  el.classList.add("hidden");
}

function goHome(push = false) {
  state.lastView = "home";
  state.currentIndex = null;
  showEl(els.homeView);
  hideEl(els.sectionView);
  hideEl(els.refView);
  setTitle("");
  renderHome(els.searchInput.value);
  if (push) history.pushState({ view: "home" }, "", "#/");
}

function showSection(index, push = false) {
  const section = SECTIONS[index];
  if (!section) return;

  state.lastView = "section";
  state.currentIndex = index;

  hideEl(els.homeView);
  showEl(els.sectionView);
  hideEl(els.refView);

  els.sectionTitle.textContent = section.title || "";
  els.sectionMeta.textContent = "";
  els.sectionContent.innerHTML = "";

  // Render section content
  const contentWrap = document.createElement("div");
  contentWrap.innerHTML = section.html || "";

  // Normalize list structure from PDF artifacts
  normalizePdfListStructure(contentWrap);

  // Wire dropdowns and reference links
  wireDropdowns(contentWrap);
  wireReferenceLinks(contentWrap);

  // Append sources at bottom if present
  if (Array.isArray(section.sources) && section.sources.length) {
    const sources = document.createElement("div");
    sources.className = "sources";
    sources.innerHTML = `
      <h3>Sources</h3>
      <ul class="clinical-list level-1">
        ${section.sources.map(s => `<li>${escapeHtml(s)}</li>`).join("")}
      </ul>
    `;
    contentWrap.appendChild(sources);
  }

  els.sectionContent.appendChild(contentWrap);

  setTitle(section.title || "");
  if (push) history.pushState({ view: "section", index }, "", `#/section/${index}`);
}

function showReference(refFile, push = false) {
  if (!refFile) return;
  state.lastView = "ref";
  hideEl(els.homeView);
  hideEl(els.sectionView);
  showEl(els.refView);

  els.refMeta.textContent = refFile;
  els.refFrame.src = refFile;

  setTitle("Reference");
  if (push) history.pushState({ view: "ref", refFile }, "", `#/ref/${encodeURIComponent(refFile)}`);
}

/* ===========================
   HOME RENDER
   =========================== */

function renderHome(filterText) {
  // ✅ Guard: if SECTIONS isn't loaded, show an explicit error instead of “missing home”
  if (!Array.isArray(SECTIONS) || SECTIONS.length === 0) {
    els.homeView.innerHTML =
      `<p class="section-empty">No sections loaded. Ensure <code>script.js</code> contains <code>const SECTIONS = [...]</code> and that the deployed file matches your local version.</p>`;
    return;
  }

  const q = (filterText || "").trim().toLowerCase();
  const matches = SECTIONS
    .map((s, idx) => ({ ...s, idx }))
    .filter(s => !q || String(s.title || "").toLowerCase().includes(q));

  if (!matches.length) {
    els.homeView.innerHTML = `<p class="section-empty">No matches. Try a different search.</p>`;
    return;
  }

  const cards = matches.map(s => `
    <div class="section-card" role="button" tabindex="0" data-index="${s.idx}">
      <p class="section-card-title">${escapeHtml(s.title)}</p>
      <p class="section-card-sub">Tap to open</p>
    </div>
  `).join("");

  els.homeView.innerHTML = `
    <h2 class="card-title">Sections</h2>
    <div class="section-list">${cards}</div>
  `;

  els.homeView.querySelectorAll(".section-card").forEach(card => {
    const open = () => showSection(Number(card.dataset.index), true);
    card.addEventListener("click", open);
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        open();
      }
    });
  });
}

/* ===========================
   DROPDOWNS + LINKS
   =========================== */

function wireDropdowns(root) {
  root.querySelectorAll(".drop-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const expanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", expanded ? "false" : "true");
      const panel = btn.closest(".drop")?.querySelector(".drop-panel");
      if (panel) panel.hidden = expanded;
    });
  });
}

function wireReferenceLinks(root) {
  root.querySelectorAll(".ref-link").forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      const ref = a.getAttribute("data-ref");
      showReference(ref, true);
    });
  });
}

/* ===========================
   FIXES: PDF LIST STRUCTURE NORMALIZATION
   =========================== */
/**
 * Repairs common PDF-to-HTML mistakes:
 * - Ensures <ul> never becomes a sibling of a <li> when it should be nested within that <li>.
 * - Ensures dropdown containers live inside <li> and do not break list structure.
 */
function normalizePdfListStructure(root) {
  // Fix any <ul> directly under another <ul> (as a sibling) by nesting into the previous <li>
  root.querySelectorAll("ul").forEach(ul => {
    Array.from(ul.children).forEach((child, idx) => {
      if (child.tagName && child.tagName.toLowerCase() === "ul") {
        const prev = ul.children[idx - 1];
        if (prev && prev.tagName && prev.tagName.toLowerCase() === "li") {
          prev.appendChild(child);
        }
      }
    });
  });

  // If a .drop exists directly under a <ul>, wrap it inside a <li> (required invariant)
  root.querySelectorAll("ul > .drop").forEach(drop => {
    const li = document.createElement("li");
    li.appendChild(drop);
    drop.parentElement.insertBefore(li, drop.parentElement.firstChild);
  });
}

/* ===========================
   NAVIGATION + EVENTS
   =========================== */

function handleHashRoute() {
  const hash = location.hash || "#/";
  const parts = hash.replace("#/", "").split("/").filter(Boolean);

  if (!parts.length) {
    goHome(false);
    return;
  }

  if (parts[0] === "section" && parts[1] != null) {
    const idx = Number(parts[1]);
    if (!Number.isNaN(idx)) showSection(idx, false);
    else goHome(false);
    return;
  }

  if (parts[0] === "ref" && parts[1]) {
    const refFile = decodeURIComponent(parts.slice(1).join("/"));
    showReference(refFile, false);
    return;
  }

  goHome(false);
}

function init() {
  setTitle("");

  els.backBtn?.addEventListener("click", () => history.back());
  els.refBackBtn?.addEventListener("click", () => history.back());

  els.homeIconBtn?.addEventListener("click", () => goHome(true));

  els.searchInput?.addEventListener("input", () => {
    renderHome(els.searchInput.value);
  });

  els.searchInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const q = (els.searchInput.value || "").trim().toLowerCase();
      const idx = SECTIONS.findIndex(s => String(s.title || "").toLowerCase().includes(q));
      if (idx >= 0) showSection(idx, true);
    }
  });

  window.addEventListener("popstate", handleHashRoute);
  window.addEventListener("hashchange", handleHashRoute);

  // Initial render based on URL
  handleHashRoute();
}

document.addEventListener("DOMContentLoaded", init);
